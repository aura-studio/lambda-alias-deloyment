# 工作流程图

## 完整发布流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAD 完整发布流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

开发者                        LAD                          AWS
  │                            │                            │
  │  1. 代码修改完成            │                            │
  │─────────────────────────►  │                            │
  │                            │                            │
  │  2. sam build              │                            │
  │────────────────────────────┼──────────────────────────► │
  │                            │                            │ 构建镜像
  │                            │                            │
  │  3. sam deploy             │                            │
  │────────────────────────────┼──────────────────────────► │
  │                            │                            │ 部署 CloudFormation
  │                            │                            │ 创建新 Version
  │                            │                            │ 更新 Alias (同版本)
  │                            │                            │
  │  4. lad deploy             │                            │
  │─────────────────────────►  │                            │
  │                            │  获取最新版本号             │
  │                            │──────────────────────────► │
  │                            │                            │
  │                            │  更新 latest 别名          │
  │                            │──────────────────────────► │
  │                            │                            │
  │  5. 测试 latest 别名        │                            │
  │────────────────────────────┼──────────────────────────► │
  │                            │                            │
  │  6. lad canary             │                            │
  │     --percent 10           │                            │
  │─────────────────────────►  │                            │
  │                            │  配置 live 流量路由         │
  │                            │  90% → v1, 10% → v2        │
  │                            │──────────────────────────► │
  │                            │                            │
  │  7. 监控指标                │                            │
  │◄───────────────────────────┼────────────────────────────│
  │                            │                            │
  │  8a. 指标正常               │                            │
  │      lad canary            │                            │
  │      --percent 50          │                            │
  │─────────────────────────►  │                            │
  │                            │  50% → v1, 50% → v2        │
  │                            │──────────────────────────► │
  │                            │                            │
  │  9. lad promote            │                            │
  │─────────────────────────►  │                            │
  │                            │  保存 v1 到 previous       │
  │                            │  live 100% → v2            │
  │                            │──────────────────────────► │
  │                            │                            │
  │  ════════════════════════════════════════════════════  │
  │                            │                            │
  │  8b. 指标异常               │                            │
  │      lad rollback          │                            │
  │─────────────────────────►  │                            │
  │                            │  live 100% → v1            │
  │                            │  latest → v1               │
  │                            │──────────────────────────► │
  │                            │                            │
```

## 快速发布流程 (跳过灰度)

```
sam build → sam deploy → lad deploy → lad promote
```

## 自动灰度流程

```
sam build → sam deploy → lad deploy → lad auto
```

自动按 `--percent` 指定的步长递进（默认 10%），每阶段等待 `--wait` 指定的时间（默认 5m）。

示例：
- `lad auto` → 10% → 20% → ... → 90% → promote，每阶段等待 5 分钟
- `lad auto --percent 25 --wait 1h` → 25% → 50% → 75% → promote，每阶段等待 1 小时

## 紧急回退流程

```
发现问题 → lad rollback → 排查修复 → 重新发布
```
