# 状态转换检查

## 状态定义

| 状态 | live | latest | previous | 灰度配置 |
|------|------|--------|----------|----------|
| 稳定态 | vN | vN | vN-1 | 无 |
| 待验证态 | vN | vN+1 | vN-1 | 无 |
| 灰度态 | vN→vN+1 | vN+1 | vN-1 | 有 |
| 回退态 | vN | vN | vN | 无 |

## 命令状态转换矩阵

### deploy 命令

| 当前状态 | 操作结果 | 说明 |
|----------|----------|------|
| 稳定态 | → 待验证态 | ✅ 正常流程 |
| 待验证态 | ❌ 阻止 | 需先 promote 或 rollback |
| 灰度态 | ❌ 阻止 | 检测到活跃灰度，需先完成 |
| 回退态 | → 待验证态 | ✅ 正常流程 |

### canary 命令

| 当前状态 | 百分比 | 操作结果 | 说明 |
|----------|--------|----------|------|
| 稳定态 | 1-100 | ❌ 阻止 | live==latest，需先 deploy |
| 稳定态 | 0 | 无变化 | ✅ 无灰度可清除 |
| 待验证态 | 1-100 | → 灰度态 | ✅ 正常流程 |
| 待验证态 | 0 | 无变化 | ✅ 无灰度可清除 |
| 灰度态 | 1-100 | 灰度态 | ✅ 调整灰度比例 |
| 灰度态 | 0 | → 待验证态 | ✅ 清除灰度配置 |
| 回退态 | 1-100 | ❌ 阻止 | live==latest，需先 deploy |
| 回退态 | 0 | 无变化 | ✅ 无灰度可清除 |

### promote 命令

| 当前状态 | 操作结果 | 说明 |
|----------|----------|------|
| 稳定态 | ✅ 无操作 | live==latest，幂等返回成功 |
| 待验证态 | → 稳定态 | ✅ 跳过灰度直接发布（有警告） |
| 灰度态 | → 稳定态 | ✅ 正常流程 |
| 回退态 | ✅ 无操作 | live==latest，幂等返回成功 |

### rollback 命令

| 当前状态 | 操作结果 | 说明 |
|----------|----------|------|
| 稳定态 | → 回退态 | ✅ 回退到 previous |
| 待验证态 | → 回退态 | ✅ 回退到 previous |
| 灰度态 | → 回退态 | ✅ 清除灰度并回退 |
| 回退态 | ✅ 无操作 | live==previous，幂等返回成功 |

### auto 命令

| 当前状态 | 操作结果 | 说明 |
|----------|----------|------|
| 稳定态 | ❌ 阻止 | live==latest，需先 deploy |
| 待验证态 | → 稳定态 | ✅ 自动递进到 100% |
| 灰度态 | → 稳定态 | ⚠️ 从头开始递进（可能降低比例） |
| 回退态 | ❌ 阻止 | live==latest，需先 deploy |

## 安全检查

### 已实现的保护

1. **deploy 阻止活跃灰度**：防止在灰度过程中部署新版本
2. **canary 检查版本差异**：live==latest 时阻止（--percent 0 除外）
3. **promote 幂等**：live==latest 时直接返回成功
4. **rollback 幂等**：live==previous 时直接返回成功
5. **rollback 更新 latest**：防止回退后 promote 又推上问题版本
6. **--percent 100 警告**：提示用户使用 promote 更安全

### 误操作场景

| 误操作 | 结果 | 保护机制 |
|--------|------|----------|
| promote 后再 promote | 无操作 | 幂等检查 |
| rollback 后再 rollback | 无操作 | 幂等检查 |
| 灰度中 deploy | 阻止 | 活跃灰度检查 |
| 无新版本时 canary | 阻止 | 版本差异检查 |
| canary 后 auto | 从头递进 | ⚠️ 需用户注意 |

## 推荐工作流

```
正常发布:
  deploy → canary --percent 10 → canary --percent 25 → canary --percent 50 → canary --percent 75 → promote

快速发布:
  deploy → promote (跳过灰度，有警告)

自动发布:
  deploy → auto --wait 5m

紧急回退:
  rollback → (排查问题) → deploy → ...

取消灰度:
  canary --percent 0 → (保持待验证态，可重新开始灰度)
```
