# SAM 协同图

## SAM 与 LAD 的职责划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SAM 与 LAD 协同关系                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────┐    ┌─────────────────────────────────┐
│             SAM                 │    │             LAD                 │
│                                 │    │                                 │
│  ┌───────────────────────────┐  │    │  ┌───────────────────────────┐  │
│  │ 基础设施管理               │  │    │  │ 版本管理                   │  │
│  │                           │  │    │  │                           │  │
│  │ • Lambda Function         │  │    │  │ • 别名指向调整             │  │
│  │ • API Gateway             │  │    │  │ • 流量路由配置             │  │
│  │ • IAM Role                │  │    │  │ • 灰度策略执行             │  │
│  │ • EventBridge Schedule    │  │    │  │ • 版本回退                 │  │
│  │ • Version (每次部署新建)   │  │    │  │                           │  │
│  │ • Alias (初始指向)         │  │    │  │                           │  │
│  └───────────────────────────┘  │    │  └───────────────────────────┘  │
│                                 │    │                                 │
│  ┌───────────────────────────┐  │    │  ┌───────────────────────────┐  │
│  │ 模板管理                   │  │    │  │ 模板补丁                   │  │
│  │                           │  │    │  │                           │  │
│  │ • template.yaml           │  │◄───┼──│ • lad patch               │  │
│  │ • samconfig.toml          │  │    │  │ • lad unpatch             │  │
│  └───────────────────────────┘  │    │  └───────────────────────────┘  │
│                                 │    │                                 │
└─────────────────────────────────┘    └─────────────────────────────────┘
              │                                      │
              │                                      │
              ▼                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AWS Cloud                                       │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Lambda    │  │ API Gateway │  │  Schedule   │  │  IAM Role   │        │
│  │             │  │             │  │             │  │             │        │
│  │  Function   │  │   HttpApi   │  │  Schedule1  │  │   Role1     │        │
│  │  Version    │  │             │  │  Schedule2  │  │   Role2     │        │
│  │  Alias x3   │  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 部署时序

```
┌────────┐          ┌────────┐          ┌────────┐          ┌────────┐
│  开发者 │          │  SAM   │          │  LAD   │          │  AWS   │
└───┬────┘          └───┬────┘          └───┬────┘          └───┬────┘
    │                   │                   │                   │
    │  lad patch        │                   │                   │
    │───────────────────┼─────────────────► │                   │
    │                   │                   │ 修改 template.yaml │
    │                   │                   │                   │
    │  sam build        │                   │                   │
    │─────────────────► │                   │                   │
    │                   │ 构建 Docker 镜像   │                   │
    │                   │───────────────────┼─────────────────► │
    │                   │                   │                   │
    │  sam deploy       │                   │                   │
    │─────────────────► │                   │                   │
    │                   │ 部署 CloudFormation│                   │
    │                   │───────────────────┼─────────────────► │
    │                   │                   │                   │ 创建资源
    │                   │                   │                   │ • Function
    │                   │                   │                   │ • Version (v2)
    │                   │                   │                   │ • Alias (all→v2)
    │                   │                   │                   │
    │  lad deploy       │                   │                   │
    │───────────────────┼─────────────────► │                   │
    │                   │                   │ 调整别名指向        │
    │                   │                   │─────────────────► │
    │                   │                   │                   │ live → v1
    │                   │                   │                   │ latest → v2
    │                   │                   │                   │ previous → v1
    │                   │                   │                   │
```

## template.yaml 补丁内容

```yaml
# SAM 原有资源
Resources:
  Function:
    Type: AWS::Serverless::Function
    ...

  Schedule1:
    Type: AWS::Scheduler::Schedule
    Properties:
      Target:
        # <<< LAD_ORIGINAL: Arn: !GetAtt Function.Arn >>>
        Arn: !Ref LiveAlias    # ← LAD 修改

# >>>>>> DEPLOY_SCRIPT_PATCH_START <<<<<<
# LAD 添加的资源

  FunctionVersion:
    Type: AWS::Lambda::Version
    ...

  LiveAlias:
    Type: AWS::Lambda::Alias
    Properties:
      Name: live
      ...

  PreviousAlias:
    Type: AWS::Lambda::Alias
    Properties:
      Name: previous
      ...

  LatestAlias:
    Type: AWS::Lambda::Alias
    Properties:
      Name: latest
      ...

# >>>>>> DEPLOY_SCRIPT_PATCH_END <<<<<<
```
